name: NPM Security Audit

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  npm-audit:
    name: Frontend NPM Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run npm audit
        id: audit
        working-directory: frontend
        run: |
          npm audit --audit-level=moderate --json > audit-results.json || true
          cat audit-results.json
        continue-on-error: true
      
      - name: Parse audit results
        id: parse_results
        working-directory: frontend
        run: |
          if [ -f audit-results.json ]; then
            # Extract vulnerability counts
            CRITICAL=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical")) | length' audit-results.json)
            HIGH=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "high")) | length' audit-results.json)
            MODERATE=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "moderate")) | length' audit-results.json)
            LOW=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "low")) | length' audit-results.json)
            INFO=$(jq '.vulnerabilities | to_entries | map(select(.value.severity == "info")) | length' audit-results.json)
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "info=$INFO" >> $GITHUB_OUTPUT
            
            # Build summary
            SUMMARY="## üîí NPM Security Audit Results\n\n"
            SUMMARY="${SUMMARY}### Vulnerability Summary\n"
            SUMMARY="${SUMMARY}| Severity | Count |\n"
            SUMMARY="${SUMMARY}|----------|-------|\n"
            SUMMARY="${SUMMARY}| üî¥ Critical | $CRITICAL |\n"
            SUMMARY="${SUMMARY}| üü† High | $HIGH |\n"
            SUMMARY="${SUMMARY}| üü° Moderate | $MODERATE |\n"
            SUMMARY="${SUMMARY}| ‚ö™ Low | $LOW |\n"
            SUMMARY="${SUMMARY}| ‚ÑπÔ∏è Info | $INFO |\n\n"
            
            if [ $((CRITICAL + HIGH + MODERATE)) -gt 0 ]; then
              SUMMARY="${SUMMARY}‚ö†Ô∏è **Action Required**: Moderate or higher severity vulnerabilities detected.\n\n"
              SUMMARY="${SUMMARY}Run \`npm audit fix\` to attempt automatic remediation.\n\n"
            else
              SUMMARY="${SUMMARY}‚úÖ No Moderate or higher severity vulnerabilities detected.\n\n"
            fi
            
            SUMMARY="${SUMMARY}View the detailed [NPM Audit Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more information."
            
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo -e "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=‚ö†Ô∏è NPM audit results not generated." >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "moderate=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "info=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: frontend/audit-results.json
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.parse_results.outputs.summary }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
      
      - name: Fail if moderate+ vulnerabilities found
        if: always()
        run: |
          CRITICAL=${{ steps.parse_results.outputs.critical }}
          HIGH=${{ steps.parse_results.outputs.high }}
          MODERATE=${{ steps.parse_results.outputs.moderate }}
          
          if [ $((CRITICAL + HIGH + MODERATE)) -gt 0 ]; then
            echo "‚ùå Found $CRITICAL critical, $HIGH high, and $MODERATE moderate severity vulnerabilities"
            exit 1
          fi
