services:
  ai-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${DB_NAME:-ai}
      POSTGRES_USER: ${DB_USER:-ai}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-ai}
    volumes:
      - ai_db_dev_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ai}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - ai_dev_network
    profiles:
      - full

  ai-orchestrator:
    build:
      context: ./ai-orchestrator
      dockerfile: Dockerfile
      # Use buildkit for faster incremental builds
      args:
        BUILDKIT_INLINE_CACHE: 1
    environment:
      SPRING_PROFILES_ACTIVE: dev
      DB_URL: jdbc:postgresql://ai-db:5432/${DB_NAME:-ai}
      DB_USER: ${DB_USER:-ai}
      DB_PASSWORD: ${DB_PASSWORD:-ai}
      ORCHESTRATOR_TOKEN: ${ORCHESTRATOR_TOKEN:-dev-token}
      LLM_API_KEY: ${LLM_API_KEY:-dev-key}
      # Debug settings
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_EXAMPLE: DEBUG
      # Enable debug port for IDE integration (optional)
      JAVA_TOOL_OPTIONS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
    depends_on:
      ai-db:
        condition: service_healthy
    ports:
      - "8080:8080"
      - "5005:5005"  # Java debug port
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - ai_dev_network
    profiles:
      - full
      - backend

  ai-dashboard-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    environment:
      NG_CLI_ANALYTICS: ci
      ANGULAR_ENVIRONMENT: development
    ports:
      - "4200:4200"
    volumes:
      # Bind mount source for hot reload
      - ./frontend/src:/app/src
      - ./frontend/angular.json:/app/angular.json
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/tsconfig.spec.json:/app/tsconfig.spec.json
      - ./frontend/nginx.conf:/app/nginx.conf
      - ./frontend/proxy.conf.json:/app/proxy.conf.json
      # Named volume for node_modules (prevent sync from host)
      - frontend_node_modules:/app/node_modules
    depends_on:
      ai-orchestrator:
        condition: service_healthy
    networks:
      - ai_dev_network
    profiles:
      - full
      - frontend

  # Optional: Redis for caching/sessions (uncomment if needed)
  # ai-redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - ai_redis_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - ai_dev_network
  #   profiles:
  #     - full

networks:
  ai_dev_network:
    driver: bridge

volumes:
  ai_db_dev_data:
    driver: local
  frontend_node_modules:
    driver: local
  # ai_redis_data:
  #   driver: local
