# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# AITEAM ‚Äî GitLab CI/CD Pipeline (PRIMARY)
#
# Stages:
#   build   ‚Äî Build backend JAR + frontend dist
#   test    ‚Äî Run tests (Maven verify + Playwright E2E)
#   deploy  ‚Äî Deploy to production via SSH + docker-compose
#
# Required CI/CD variables (Settings ‚Üí CI/CD ‚Üí Variables):
#   DEPLOY_SSH_KEY   ‚Äî private ed25519 key (base64 encoded)
#   DEPLOY_HOST      ‚Äî production server IP/hostname
#   DEPLOY_USER      ‚Äî SSH username (e.g., root, ubuntu, deploy)
#   DEPLOY_DIR       ‚Äî deployment directory (e.g., /opt/aiteam)
#   GHCR_TOKEN       ‚Äî GitHub token for GHCR push (base64)
#   GHCR_USERNAME    ‚Äî GitHub username for GHCR
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

stages:
  - build
  - test
  - load-test
  - deploy

variables:
  DEPLOY_HOST: "${DEPLOY_HOST}"
  DEPLOY_USER: "${DEPLOY_USER}"
  DEPLOY_DIR: "${DEPLOY_DIR}"
  GHCR_REGISTRY: "ghcr.io"
  GHCR_IMAGE_BACKEND: "${GHCR_REGISTRY}/${CI_PROJECT_NAMESPACE}/ai-orchestrator"
  GHCR_IMAGE_FRONTEND: "${GHCR_REGISTRY}/${CI_PROJECT_NAMESPACE}/ai-dashboard"

# ‚îÄ‚îÄ Reusable SSH setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
.ssh_setup:
  image: debian:bookworm-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq openssh-client rsync git 2>/dev/null
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_SSH_KEY" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null
    - chmod 644 ~/.ssh/known_hosts

# ‚îÄ‚îÄ Reusable Docker setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
.docker_setup:
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  before_script:
    - echo "$GHCR_TOKEN" | base64 -d | docker login -u "$GHCR_USERNAME" --password-stdin $GHCR_REGISTRY

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# BUILD
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

build-backend:
  stage: build
  image: maven:3.9-eclipse-temurin-17-alpine
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - ai-orchestrator/**/*
        - .gitlab-ci.yml
  cache:
    key: "maven-$CI_COMMIT_REF_SLUG"
    paths:
      - .m2/repository/
    policy: pull-push
  script:
    - echo "üî® Building backend JAR..."
    - cd ai-orchestrator
    - mvn clean package -DskipTests -q
    - ls -lh target/*.jar
    - echo "‚úÖ Backend JAR built successfully"
  artifacts:
    name: "backend-jar-$CI_COMMIT_SHORT_SHA"
    paths:
      - ai-orchestrator/target/*.jar
    expire_in: 1 hour
    reports:
      dotenv: build.env

build-frontend:
  stage: build
  image: node:22-alpine
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - frontend/**/*
        - .gitlab-ci.yml
  cache:
    key: "npm-$CI_COMMIT_REF_SLUG"
    paths:
      - frontend/node_modules/
    policy: pull-push
  script:
    - echo "üî® Building frontend dist..."
    - cd frontend
    - npm ci --prefer-offline
    - npm run build -- --configuration production
    - ls -lh dist/dashboard/browser/
    - echo "‚úÖ Frontend dist built successfully"
  artifacts:
    name: "frontend-dist-$CI_COMMIT_SHORT_SHA"
    paths:
      - frontend/dist/dashboard/browser/
    expire_in: 1 hour

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# TEST
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

test-backend:
  stage: test
  image: maven:3.9-eclipse-temurin-17-alpine
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - ai-orchestrator/**/*
        - .gitlab-ci.yml
  cache:
    key: "maven-$CI_COMMIT_REF_SLUG"
    paths:
      - .m2/repository/
    policy: pull
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  script:
    - echo "üß™ Running backend tests (mvn verify)..."
    - cd ai-orchestrator
    - mvn verify -q -Dspring.profiles.active=test
    - echo "‚úÖ Backend tests passed"
  artifacts:
    name: "backend-test-results-$CI_COMMIT_SHORT_SHA"
    paths:
      - ai-orchestrator/target/surefire-reports/
      - ai-orchestrator/target/failsafe-reports/
    reports:
      junit: ai-orchestrator/target/*-reports/*.xml
    expire_in: 30 days
    when: always

test-frontend:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - frontend/**/*
        - .gitlab-ci.yml
  cache:
    key: "npm-$CI_COMMIT_REF_SLUG"
    paths:
      - frontend/node_modules/
    policy: pull
  script:
    - echo "üß™ Running frontend E2E tests (npm run e2e)..."
    - cd frontend
    - npm ci --prefer-offline
    - npx playwright install --with-deps
    - npm run e2e
    - echo "‚úÖ Frontend E2E tests passed"
  artifacts:
    name: "frontend-test-results-$CI_COMMIT_SHORT_SHA"
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    reports:
      junit: frontend/test-results/junit.xml
    expire_in: 30 days
    when: always

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# LOAD TEST
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

load-test:
  stage: load-test
  image: grafana/k6:0.49.0
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      when: manual
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    BASE_URL: "${LOAD_TEST_URL:-http://localhost:8088}"
    WS_URL: "${LOAD_TEST_WS_URL:-ws://localhost:8088}"
  before_script:
    - apk add --no-cache bash jq bc curl
    - chmod +x infra/ci-cd/scripts/load-test.sh
    - chmod +x infra/ci-cd/scripts/analyze-load-results.sh
  script:
    - echo "üöÄ Starting load tests..."
    - echo "   Target URL: $BASE_URL"
    - echo "   WebSocket URL: $WS_URL"
    - |
      # Start local environment if testing locally
      if [ "$BASE_URL" = "http://localhost:8088" ]; then
        echo "‚ö†Ô∏è  Local testing mode - ensure services are running"
      fi
    - bash infra/ci-cd/scripts/load-test.sh all staging
    - echo "‚úÖ Load tests completed"
  artifacts:
    name: "load-test-results-$CI_COMMIT_SHORT_SHA"
    paths:
      - ai-orchestrator/target/load-test-results/
    reports:
      junit: ai-orchestrator/target/load-test-results/*_summary.json
    expire_in: 30 days
    when: always
  allow_failure: true

load-test-production:
  stage: load-test
  image: grafana/k6:0.49.0
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  variables:
    BASE_URL: "${PRODUCTION_URL}"
    WS_URL: "${PRODUCTION_WS_URL}"
  before_script:
    - apk add --no-cache bash jq bc curl
    - chmod +x infra/ci-cd/scripts/load-test.sh
    - chmod +x infra/ci-cd/scripts/analyze-load-results.sh
  script:
    - echo "üöÄ Starting production load tests..."
    - echo "   Target URL: $BASE_URL"
    - bash infra/ci-cd/scripts/load-test.sh all production
    - echo "‚úÖ Production load tests completed"
  artifacts:
    name: "load-test-prod-results-$CI_COMMIT_SHORT_SHA"
    paths:
      - ai-orchestrator/target/load-test-results/
    expire_in: 90 days
    when: always
  allow_failure: false

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# DEPLOY
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

deploy-production:
  stage: deploy
  extends: .ssh_setup
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  script:
    - echo "üöÄ Deploying aiteam to production..."
    - echo "   Host: $DEPLOY_HOST"
    - echo "   User: $DEPLOY_USER"
    - echo "   Dir: $DEPLOY_DIR"
    - |
      ssh -o ConnectTimeout=10 "$DEPLOY_USER@$DEPLOY_HOST" "
        set -e
        echo 'üìç Connecting to production server...'
        echo 'üîÑ Pulling latest code from GitLab...'
        cd $DEPLOY_DIR
        git pull origin main --quiet
        
        echo 'üê≥ Pulling latest images from GHCR...'
        docker-compose -f docker-compose.prod.yml pull
        
        echo 'üíæ Running pre-deployment backup...'
        ./scripts/deploy.sh prod
        
        echo '‚úÖ Deployment complete'
        echo 'üìä Service status:'
        docker-compose -f docker-compose.prod.yml ps
      "
    - echo "‚úÖ Production deployment successful"
  environment:
    name: production
    url: https://$DEPLOY_HOST
    auto_stop_in: never

deploy-staging:
  stage: deploy
  extends: .ssh_setup
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: manual
  script:
    - echo "üöÄ Deploying aiteam to staging..."
    - echo "   Host: $DEPLOY_HOST"
    - echo "   User: $DEPLOY_USER"
    - echo "   Dir: $DEPLOY_DIR"
    - |
      ssh -o ConnectTimeout=10 "$DEPLOY_USER@$DEPLOY_HOST" "
        set -e
        echo 'üìç Connecting to staging server...'
        echo 'üîÑ Pulling latest code from GitLab (develop)...'
        cd $DEPLOY_DIR
        git checkout develop
        git pull origin develop --quiet
        
        echo 'üê≥ Pulling latest images from GHCR...'
        docker-compose -f docker-compose.dev.yml pull
        
        echo 'üöÄ Starting staging environment...'
        docker-compose -f docker-compose.dev.yml up -d
        
        echo '‚úÖ Staging deployment complete'
        echo 'üìä Service status:'
        docker-compose -f docker-compose.dev.yml ps
      "
    - echo "‚úÖ Staging deployment successful"
  environment:
    name: staging
    url: https://staging.$DEPLOY_HOST
    auto_stop_in: never

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# ROLLBACK
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

rollback-production:
  stage: deploy
  extends: .ssh_setup
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  script:
    - echo "‚ö†Ô∏è  ROLLBACK: Restoring production to previous version..."
    - echo "   Host: $DEPLOY_HOST"
    - echo "   User: $DEPLOY_USER"
    - echo "   Dir: $DEPLOY_DIR"
    - |
      ssh -o ConnectTimeout=10 "$DEPLOY_USER@$DEPLOY_HOST" "
        set -e
        cd $DEPLOY_DIR
        echo 'üîÑ Running rollback script...'
        ./scripts/rollback.sh prod
        echo '‚úÖ Rollback complete'
        echo 'üìä Service status after rollback:'
        docker-compose -f docker-compose.prod.yml ps
      "
    - echo "‚úÖ Production rollback successful"
  environment:
    name: production
    action: rollback

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# NOTIFICATIONS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

.notify_slack:
  image: debian:bookworm-slim
  script:
    - apt-get update -qq && apt-get install -y -qq curl 2>/dev/null
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{
          \"text\": \"$SLACK_MESSAGE\",
          \"blocks\": [
            {
              \"type\": \"section\",
              \"text\": {
                \"type\": \"mrkdwn\",
                \"text\": \"*$SLACK_TITLE*\n$SLACK_MESSAGE\"
              }
            }
          ]
        }" || true
  when: on_failure

notify-deploy-failure:
  extends: .notify_slack
  stage: deploy
  variables:
    SLACK_TITLE: "‚ùå AITEAM Deployment Failed"
    SLACK_MESSAGE: "Branch: $CI_COMMIT_BRANCH\nCommit: $CI_COMMIT_SHORT_SHA\nPipeline: $CI_PIPELINE_URL"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      when: on_failure
